---
import Stripe from "stripe";
import * as z from "zod";
import { STRIPE_SECRET_KEY } from "astro:env/server";

import PageLayout from "@/layouts/PageLayout.astro";
import { getPageTranslations, languagePrefixes } from "@/utils/i18n";
import { bookEvent, resetCache } from "@/services/calendly";
import { EVENT_TYPE } from "@/components/booking/types";
import { formatEventComment } from "@/components/booking/eventMessage";
import { getPaymentIntentId } from "@/services/stripe";
import splashPlayLogo from "@/assets/splash-play-logo.svg";

export const prerender = false;

const { lang } = Astro.params;
const translations = getPageTranslations(lang, "complete");
const sessionId = Astro.url.searchParams.get("session_id");

if (!sessionId) {
    return Astro.redirect("/");
}

const stripe = new Stripe(STRIPE_SECRET_KEY, {
    apiVersion: "2025-10-29.clover",
});

let status = "loading";
let sessionTitle = "";

const metadataSchema = z.object({
    eventType: z.enum(Object.values(EVENT_TYPE)),
    sessionTime: z.iso.datetime(),
    sessionTitle: z.string(),
});

const customerSchema = z.object({
    email: z.email(),
    individual_name: z.string(),
    phone: z.string(),
});

try {
    const session = await stripe.checkout.sessions.retrieve(sessionId);

    const parsedMetadata = metadataSchema.safeParse(session.metadata);
    const parsedCustomer = customerSchema.safeParse(session.customer_details);
    const paymentIntentId = getPaymentIntentId(session);

    if (
        session.status === "complete" &&
        session.payment_status === "paid" &&
        parsedMetadata.success &&
        parsedCustomer.success
    ) {
        const isOk = await bookEvent(parsedMetadata.data.eventType, {
            datetime: parsedMetadata.data.sessionTime,
            email: parsedCustomer.data.email,
            name: parsedCustomer.data.individual_name,
            phone: parsedCustomer.data.phone,
            comment: formatEventComment(
                paymentIntentId,
                parsedMetadata.data.sessionTitle,
            ),
        });

        status = "success";
        sessionTitle = parsedMetadata.data.sessionTitle;
        if (isOk) {
            resetCache();
        } else {
            console.log("error while booking an event", session.id);
        }
    } else if (session.status === "open") {
        status = "processing";
    } else {
        status = "failed";
    }
} catch (error) {
    console.error("Error retrieving Stripe session:", error);
    status = "error";
}
---

<PageLayout title={translations.title}>
    <div class="container">
        <img src={splashPlayLogo.src} alt="Splash Play" class="logo" />
        <div class="content">
            <h1>
                {
                    status === "success"
                        ? translations.title
                        : status === "processing"
                          ? translations.processing
                          : translations.failed
                }
            </h1>

            {
                status === "success" && sessionTitle && (
                    <p class="session-title">{sessionTitle}</p>
                )
            }

            {
                status === "success" && (
                    <p class="message">{translations.message}</p>
                )
            }

            <div class="actions">
                <a
                    href={languagePrefixes[
                        lang as keyof typeof languagePrefixes
                    ] || "/"}
                    class="main-link">{translations.return_to_main}</a
                >

                {
                    status === "failed" || status === "error" ? (
                        <a
                            href={`${languagePrefixes[lang as keyof typeof languagePrefixes] || ""}/book`}
                            class="book-link"
                        >
                            {translations.back_to_book}
                        </a>
                    ) : null
                }
            </div>
        </div>
    </div>
</PageLayout>

<style>
    .container {
        display: flex;
        flex-direction: column;
        align-items: center;
        min-height: 80vh;
        padding: 32px;
    }

    .content {
        background: var(--white);
        padding: 48px;
        border-radius: 1rem;
        box-shadow: 0 4px 6px var(--shadow-color);
        max-width: 37.5rem;
        width: 100%;
    }

    .logo {
        width: 15.625rem;
        height: auto;
        margin-bottom: 32px;
        display: block;
    }

    .session-title {
        margin: 16px 0 32px 0;
        font-size: 1.2rem;
        text-wrap: pretty;
    }

    .actions {
        display: flex;
        flex-direction: column;
        gap: 16px;
    }

    @media (max-width: 40rem) {
        .container {
            padding: 24px 8px;
        }

        .content {
            padding: 24px;
        }

        .logo {
            width: 11.25rem;
        }
    }
</style>
